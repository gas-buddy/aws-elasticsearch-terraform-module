# This file is generated by an ERB template. Do not edit it directly.
<% %w(a b c d e).each do |az| -%>

resource "aws_instance" "data_<%= az %>" {
  count = "${contains(keys(var.subnet_ids), "<%= az %>") ? (var.data_nodes_per_subnet) : 0}"

  instance_type = "${var.data_instance_type}"
  ami = "${var.hvm_ami}"
  key_name = "${var.key_name}"
  iam_instance_profile = "${var.iam_instance_profile}"
  vpc_security_group_ids = [
    "${concat(var.additional_security_group_ids, list("${aws_security_group.elasticsearch_data.id}"))}"
  ]
  subnet_id = "${lookup(var.subnet_ids, "<%= az %>", "")}"
  monitoring = "${var.data_monitoring}"

  tags = "${merge(var.tags, map("Name", format("elasticsearch-data-%s-<%= az %>-%d", var.cluster_name, count.index+1), "Job", "elasticsearch-data"))}"
}

# This is necessary so that we can reference the IP of the instance we've just created when running ansible

resource "null_resource" "ansible_data_<%= az %>" {
  count = "${contains(keys(var.subnet_ids), "<%= az %>") ? (var.data_nodes_per_subnet) : 0}"

  provisioner "local-exec" {
    command = "sleep 120; ANSIBLE_CONFIG=${var.ansible_config} ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -u ${var.ssh_user} --private-key ${var.ssh_key_file} -e 'cluster_name=${var.cluster_name}' -e 'region=${var.region}' -e 'node_name=elasticsearch-data-${var.cluster_name}-<%= az %>' -i '${element(aws_instance.data_<%= az %>.*.private_ip, count.index)},' ${var.data_ansible_playbook}"
  }
}
<% end -%>
